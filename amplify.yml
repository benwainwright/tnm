version: 1
env:
  variables:
    CHOKIDAR_USEPOLLING: 1

frontend:
  phases:
    preBuild:
      commands:
        - nvm use $VERSION_NODE_12
        - yarn install --frozen-lockfile
        - yarn lint .
        - yarn test:ci

    build:
      commands:
        - yarn run build
  artifacts:
    baseDirectory: build
    files:
      - "**/*"
  cache:
    paths:
      - node_modules/**/*

test:
  artifacts:
    baseDirectory: cypress
    configFilePath: "**/mochawesome.json"
    files:
      - "**/*.png"
      - "**/*.mp4"
  phases:
    preTest:
      commands:
        - nvm use $VERSION_NODE_12
        - yarn install --frozen-lockfile
        - yarn cypress install
    test:
      commands:
        - yarn start-server-and-test 'yarn start' 3000 'yarn test:cypress:record'
    postTest:
      commands:
        - yarn mochawesome-merge cypress/report/mochawesome-report/*.json > cypress/report/mochawesome.json
